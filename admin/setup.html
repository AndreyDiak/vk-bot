<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VK Events Bot - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f5f5f5;
        color: #333;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 10px;
      }

      button:hover {
        background: #0056b3;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .alert {
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .step {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 4px;
      }

      .step.completed {
        background: #d4edda;
        border-color: #c3e6cb;
      }

      .step.error {
        background: #f8d7da;
        border-color: #f5c6cb;
      }

      .step-title {
        font-weight: bold;
        margin-bottom: 10px;
      }

      .step-description {
        color: #666;
        font-size: 14px;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .back-link {
        display: inline-block;
        margin-bottom: 20px;
        color: #007bff;
        text-decoration: none;
      }

      .back-link:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="/admin" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏</a>

      <div class="header">
        <h1>ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ VK –±–æ—Ç–∞</h1>
        <p>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –¥–ª—è –≤–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∏–∫–æ–≤</p>
      </div>

      <div id="alertContainer"></div>

      <div class="card">
        <h2>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

        <div class="form-group">
          <label for="groupId">ID –≥—Ä—É–ø–ø—ã –í–ö–æ–Ω—Ç–∞–∫—Ç–µ:</label>
          <input
            type="number"
            id="groupId"
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123456789"
            required
          />
          <small>–ù–∞–π–¥–∏—Ç–µ ID –≥—Ä—É–ø–ø—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤–∞</small>
        </div>

        <div class="form-group">
          <label for="webhookUrl">URL webhook:</label>
          <input
            type="url"
            id="webhookUrl"
            placeholder="https://your-bot.vercel.app/webhook"
            required
          />
          <small>URL –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π</small>
        </div>

        <div class="form-group">
          <label for="confirmationToken">–¢–æ–∫–µ–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</label>
          <input
            type="text"
            id="confirmationToken"
            placeholder="–õ—é–±–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"
            required
          />
          <small>–õ—é–±–∞—è —Å—Ç—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä—É—é –±—É–¥–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –≤–∞—à —Å–µ—Ä–≤–µ—Ä</small>
        </div>

        <button onclick="checkGroupInfo()" id="checkButton">
          –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥—Ä—É–ø–ø—É
        </button>
        <button onclick="setupBot()" id="setupButton" disabled>
          –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –±–æ—Ç–∞
        </button>
      </div>

      <div id="setupSteps" style="display: none">
        <h2>üîÑ –ü—Ä–æ—Ü–µ—Å—Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

        <div class="step" id="step1">
          <div class="step-title">1. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥—Ä—É–ø–ø–µ</div>
          <div class="step-description">
            –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –≥—Ä—É–ø–ø–µ –∏ –ø–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
          </div>
        </div>

        <div class="step" id="step2">
          <div class="step-title">2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Callback API</div>
          <div class="step-description">
            –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –í–ö–æ–Ω—Ç–∞–∫—Ç–µ
          </div>
        </div>

        <div class="step" id="step3">
          <div class="step-title">3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –±–æ—Ç–∞</div>
          <div class="step-description">
            –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–∞–≤–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞
          </div>
        </div>

        <div class="step" id="step4">
          <div class="step-title">4. –°–æ–∑–¥–∞–Ω–∏–µ –º–µ–Ω—é –±–æ—Ç–∞</div>
          <div class="step-description">
            –°–æ–∑–¥–∞–µ–º —É–¥–æ–±–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
          </div>
        </div>

        <div class="step" id="step5">
          <div class="step-title">5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã</div>
          <div class="step-description">
            –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ –≤ –æ–ø–∏—Å–∞–Ω–∏–µ
          </div>
        </div>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞...</div>
      </div>
    </div>

    <script>
      const API_BASE = window.location.origin;
      let groupInfo = null;

      // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä—É–ø–ø–µ
      async function checkGroupInfo() {
        const groupId = document.getElementById("groupId").value;

        if (!groupId) {
          showAlert("–í–≤–µ–¥–∏—Ç–µ ID –≥—Ä—É–ø–ø—ã", "error");
          return;
        }

        const button = document.getElementById("checkButton");
        button.disabled = true;
        button.textContent = "–ü—Ä–æ–≤–µ—Ä–∫–∞...";

        try {
          const response = await fetch(`${API_BASE}/api/group-info/${groupId}`);
          const result = await response.json();

          if (result.success) {
            groupInfo = result.group;
            showAlert(
              `–ì—Ä—É–ø–ø–∞ –Ω–∞–π–¥–µ–Ω–∞: "${groupInfo.name}" (${groupInfo.member_count} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)`,
              "success"
            );
            document.getElementById("setupButton").disabled = false;
          } else {
            showAlert(`–û—à–∏–±–∫–∞: ${result.error}`, "error");
          }
        } catch (error) {
          console.error("Error checking group:", error);
          showAlert("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥—Ä—É–ø–ø—ã", "error");
        } finally {
          button.disabled = false;
          button.textContent = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥—Ä—É–ø–ø—É";
        }
      }

      // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –±–æ—Ç–∞
      async function setupBot() {
        const groupId = document.getElementById("groupId").value;
        const webhookUrl = document.getElementById("webhookUrl").value;
        const confirmationToken =
          document.getElementById("confirmationToken").value;

        if (!groupId || !webhookUrl || !confirmationToken) {
          showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è", "error");
          return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —à–∞–≥–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        document.getElementById("setupSteps").style.display = "block";
        document.getElementById("loading").style.display = "block";

        const button = document.getElementById("setupButton");
        button.disabled = true;
        button.textContent = "–ù–∞—Å—Ç—Ä–æ–π–∫–∞...";

        try {
          const response = await fetch(`${API_BASE}/api/setup-bot`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              groupId: parseInt(groupId),
              webhookUrl,
              confirmationToken,
            }),
          });

          const result = await response.json();

          if (result.success) {
            showAlert("–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω! üéâ", "success");
            updateSteps(result.results);
          } else {
            showAlert(`–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: ${result.error}`, "error");
            updateSteps(result.results, true);
          }
        } catch (error) {
          console.error("Error setting up bot:", error);
          showAlert("–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞", "error");
        } finally {
          button.disabled = false;
          button.textContent = "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –±–æ—Ç–∞";
          document.getElementById("loading").style.display = "none";
        }
      }

      // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —à–∞–≥–æ–≤
      function updateSteps(results, hasError = false) {
        const steps = [
          { id: "step1", result: results.groupInfo },
          { id: "step2", result: results.callbackAPI },
          { id: "step3", result: results.permissions },
          { id: "step4", result: results.menu },
          { id: "step5", result: results.description },
        ];

        steps.forEach((step, index) => {
          const stepElement = document.getElementById(step.id);
          if (step.result) {
            if (step.result.success) {
              stepElement.classList.add("completed");
              stepElement.querySelector(".step-description").textContent +=
                " ‚úÖ";
            } else {
              stepElement.classList.add("error");
              stepElement.querySelector(
                ".step-description"
              ).textContent += ` ‚ùå ${step.result.error}`;
            }
          }
        });
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      function showAlert(message, type) {
        const container = document.getElementById("alertContainer");
        const alert = document.createElement("div");
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        container.appendChild(alert);

        setTimeout(() => {
          alert.remove();
        }, 5000);
      }

      // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ webhook URL
      document.addEventListener("DOMContentLoaded", function () {
        const webhookUrl = document.getElementById("webhookUrl");
        webhookUrl.value = `${window.location.origin}/webhook`;
      });
    </script>
  </body>
</html>
